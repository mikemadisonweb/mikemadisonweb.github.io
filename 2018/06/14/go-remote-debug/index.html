<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> How to debug Golang applications inside Docker containers using Delve · todo(): redo · Mikhail Bakulin's blog</title><meta name="description" content="Remote debugging Go programs within Docker containers from your favorite IDE (Goland, of course)"><meta name="keywords" content="golang delve goland docker container"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon_tree.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="https://mikemadisonweb.github.io/atom.xml" title="todo(): redo · Mikhail Bakulin's blog"><!-- Global Site Tag (gtag.js) - Google Analytics--><script async="" src="//www.googletagmanager.com/gtag/js?id=UA-106650807-1"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments)};
gtag('js', new Date());
gtag('config', 'UA-106650807-1');</script><meta name="generator" content="Hexo 4.2.0"></head><body><div class="fixed-width"><header><a class="logo-link" href="/"><img src="/favicon_tree.png" alt="logo"><h1 class="logo-text"><span class="logo-slashes">// todo():</span><span>redo</span></h1></a><ul class="nav nav-list"><li class="nav-list-item"><a class="nav-list-link" href="/" target="_self">BLOG</a></li><li class="nav-list-item"><a class="nav-list-link" href="/archives/" target="_self">ARCHIVE</a></li><li class="nav-list-item"><a class="nav-list-link" href="/cv/" target="_self">ABOUT</a></li></ul></header></div><main class="container"><div class="post-img-container"><img class="post-img" src="https://mikemadisonweb.github.io/2018/06/14/go-remote-debug/go-remote-debug.jpg"></div><div class="fixed-width"><div class="post"><article class="post-block"><h1 class="post-title"><span class="pre-title">//&nbsp;todo():&nbsp;</span>How to debug Golang applications inside Docker containers using Delve</h1><div class="post-tags"><a class="post-tag" href="/tags/Golang/">Golang</a><a class="post-tag" href="/tags/Docker/">Docker</a><a class="post-tag" href="/tags/Docker-compose/">Docker-compose</a><a class="post-tag" href="/tags/Delve/">Delve</a><a class="post-tag" href="/tags/JetBrains-GoLand/">JetBrains GoLand</a></div><div class="post-date">Jun 14, 2018</div><div class="post-content"><p>Suppose you have multiple Go microservices each one acting like a web server in our application architecture and you stuck with some subtle bug which drives you crazy. You might be also tired of putting variables of your interest inside formatted output of some sort of logger to see their current values. If you are looking for a better way of debugging Go code and you are not willing to give up using Docker, this article can help you.<br><a id="more"></a><br>All the code regarding this article can be found on <a href="https://github.com/mikemadisonweb/go-debug-example" target="_blank" rel="noopener">GitHub</a> so feel free to experiment with it.</p>
<h3 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h3><p>As the time running by more and more developers all over the world are turning into facilitating Docker to setup local environment on their computers. There are multiple reasons behind it:</p>
<ul>
<li>process isolation, configurable resource usage, and network restrictions</li>
<li>fast setup and declarative configuration, which is self-describing for new team members</li>
<li>repeatable setup on multiple development stages</li>
<li>centralized version control for project dependencies</li>
<li>large community if you need an advice</li>
<li>Docker Hub registry if you are looking for Docker images that are open-source and ready to use</li>
</ul>
<p>However, it’s not an article about Docker per se. I just mean that despite allowing a huge amount of advantages Docker also challenges us to find new ways of developing and debugging our applications. In <a href="/2018/03/06/go-autoreload/">previous article</a> I have posted my Go auto-reload setup for development, this time I will reveal my way of debugging code inside Go containers. Rather then old-school console debuggers like <a href="https://golang.org/doc/gdb" target="_blank" rel="noopener">GDB</a>, I prefer using IDE integration with Delve which allows to see all the variables at once and to jump between stack frames or breakpoints easily. I will use JetBrains GoLand, but I think it can be used the same way with the most of other IDE and <a href="https://github.com/sebdah/vim-delve" target="_blank" rel="noopener">even with vim</a>.</p>
<h3 id="Building-image"><a href="#Building-image" class="headerlink" title="Building image"></a>Building image</h3><p>The easiest way of installing Delve debugger is to use <code>go get</code> command. After ensuring proper directory structure and adding needed dependencies to base Golang image debugger can be installed:<br><figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> golang:<span class="number">1.10</span>-alpine</span><br><span class="line"></span><br><span class="line"><span class="keyword">COPY</span><span class="bash"> root /</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">ENV</span> GOPATH /go</span><br><span class="line"><span class="keyword">ENV</span> PATH $GOPATH/bin:/usr/local/go/bin:$PATH</span><br><span class="line"></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> apk add --no-cache ca-certificates \</span></span><br><span class="line"><span class="bash">        dpkg \</span></span><br><span class="line"><span class="bash">        gcc \</span></span><br><span class="line"><span class="bash">        git \</span></span><br><span class="line"><span class="bash">        musl-dev \</span></span><br><span class="line"><span class="bash">    &amp;&amp; mkdir -p <span class="string">"<span class="variable">$GOPATH</span>/src"</span> <span class="string">"<span class="variable">$GOPATH</span>/bin"</span> \</span></span><br><span class="line"><span class="bash">    &amp;&amp; chmod -R 777 <span class="string">"<span class="variable">$GOPATH</span>"</span> \</span></span><br><span class="line"><span class="bash">    &amp;&amp; chmod +x /entrypoint.sh \</span></span><br><span class="line"><span class="bash">    &amp;&amp; go get github.com/derekparker/delve/cmd/dlv</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="bash"> <span class="variable">$GOPATH</span></span></span><br><span class="line"><span class="keyword">ENTRYPOINT</span><span class="bash"> [<span class="string">"/entrypoint.sh"</span>]</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">CMD</span><span class="bash"> [<span class="string">"dlv"</span>, <span class="string">"debug"</span>, <span class="string">"--headless"</span>, <span class="string">"--listen=:2345"</span>, <span class="string">"--api-version=2"</span>]</span></span><br></pre></td></tr></table></figure></p>
<p>I tried to make this Dockerfile reusable between different microservices. That’s why I added entrypoint.sh script to the image which changes the current directory before starting the container to the one that contains needed main.go file:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">GO_WORK_DIR=<span class="variable">$&#123;GO_WORK_DIR:-$GOPATH/src&#125;</span></span><br><span class="line"><span class="built_in">cd</span> <span class="variable">$&#123;GO_WORK_DIR&#125;</span></span><br><span class="line"><span class="built_in">exec</span> <span class="string">"<span class="variable">$@</span>"</span></span><br></pre></td></tr></table></figure></p>
<p>So all that we need to do for using this image by multiple different applications is to pass GO_WORK_DIR environment variable to container upon creation. If you want to share the GO_PROJECT_DIR variable between team members you can add its value to .env file and push it to the repository.<br>Running Delve in headless mode means that only server part will be executed, with will listen for external connections on port 2345. Configuring container in docker-compose then will be trivial with one little exception, custom security option should be added in order for Delve to work inside the container:<br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">'3'</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">app:</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">"app"</span></span><br><span class="line">    <span class="attr">build:</span> <span class="string">"./docker/go-debug"</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">".:$&#123;GO_PROJECT_DIR&#125;"</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="attr">GO_WORK_DIR:</span> <span class="string">"$&#123;GO_PROJECT_DIR&#125;/app"</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">"8080:8080"</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">"2345:2345"</span></span><br><span class="line">    <span class="attr">security_opt:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">"seccomp:unconfined"</span></span><br></pre></td></tr></table></figure></p>
<p>Any attempt to start a container without this option will face an error: <code>could not launch process: fork/exec [...]: operation not permitted</code>.</p>
<p>Now that we have our container up and running Delve is waiting for a connection. Let’s add configuration in GoLand to start a debugging session:</p>
<p><img src="go-debug-configuration-ide.png" alt="delve goland ide configuration example"></p>
<p>If you have tried any debugger before in any other IDE then everything else will look familiar to you. Debugging session can be started by hitting green bug button. If you place a breakpoint on a line with Go server initialization, execution will be immediately stopped on it. Otherwise, proceed to <code>localhost:8080</code> to debug your request handling function:</p>
<p><img src="go-debug-breakpoint.png" alt="delve goland ide breakpoint example"></p>
</div><p class="ending"><i>That's all for today. Happy coding!</i></p></article></div></div></main><div class="fixed-width"><footer><div class="paginator"><a class="prev" href="/2018/12/18/git-hook-prepending-commit-message/">PREV</a><a class="next" href="/2018/03/06/go-autoreload/">NEXT</a></div><div id="disqus_thread"></div><script>var disqus_shortname = 'mikemadison';
var disqus_identifier = '2018/06/14/go-remote-debug/';
var disqus_title = 'How to debug Golang applications inside Docker containers using Delve';
var disqus_url = 'https://mikemadisonweb.github.io/2018/06/14/go-remote-debug/';
(function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><script id="dsq-count-scr" src="//mikemadison.disqus.com/count.js" async></script><div class="copyright"><p><a href="/atom.xml"><img class="rss-icon" src="/images/rss_ico.png"><span> Feed |</span></a><a href="/sitemap.xml"><span> Sitemap |</span></a><span> © 2016 - 2020 <a href="https://mikemadisonweb.github.io">Mikhail Bakulin</a>, powered by <a target="_blank">Hexo</a>.</span></p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script><script src="//unpkg.com/mermaid@8.4.4/dist/mermaid.min.js?v=undefined" id="maid-script" mermaidoptioins="{&quot;startOnLoad&quot;:true,&quot;theme&quot;:&quot;forest&quot;,&quot;fontFamily&quot;:&quot;sourcesanspro, Helvetica Neue, Arial, sans-serif&quot;,&quot;logLevel&quot;:3,&quot;sequence&quot;:{&quot;showSequenceNumbers&quot;:true,&quot;useMaxWidth&quot;:true,&quot;actorFontFamily&quot;:&quot;sourcesanspro, Helvetica Neue, Arial, sans-serif&quot;}}"></script><script>if (window.mermaid) {
    var options = JSON.parse(document.getElementById('maid-script').getAttribute('mermaidoptioins'));
    mermaid.initialize(options);
}</script></body></html>