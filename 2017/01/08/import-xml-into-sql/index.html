<!DOCTYPE html><html lang="en"><head><meta name="generator" content="Hexo 3.9.0"><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> Import XML file into database · todo(): redo · Mikhail Bakulin's blog</title><meta name="description" content="Comparison between different methods of loading huge XML file into database"><meta name="keywords" content="mysql postgresql xml python sql"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon_tree.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="https://mikemadisonweb.github.io/atom.xml" title="todo(): redo · Mikhail Bakulin's blog"><!-- Global Site Tag (gtag.js) - Google Analytics--><script async src="//www.googletagmanager.com/gtag/js?id=UA-106650807-1"></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments)};
gtag('js', new Date());
gtag('config', 'UA-106650807-1');</script></head><body><div class="fixed-width"><header><a class="logo-link" href="/"><img src="/favicon_tree.png" alt="logo"><h1 class="logo-text"><span class="logo-slashes">// todo():</span><span>redo</span></h1></a><ul class="nav nav-list"><li class="nav-list-item"><a class="nav-list-link" href="/" target="_self">BLOG</a></li><li class="nav-list-item"><a class="nav-list-link" href="/archives/" target="_self">ARCHIVE</a></li><li class="nav-list-item"><a class="nav-list-link" href="/cv/" target="_self">ABOUT</a></li></ul></header></div><main class="container"><div class="post-img-container"><img class="post-img" src="https://mikemadisonweb.github.io/2017/01/08/import-xml-into-sql/import-xml-into-sql.jpeg"></div><div class="fixed-width"><div class="post"><article class="post-block"><h1 class="post-title"><span class="pre-title">//&nbsp;todo():&nbsp;</span>Import XML file into database</h1><div class="post-tags"><a class="post-tag" href="/tags/PostgreSQL/">PostgreSQL</a><a class="post-tag" href="/tags/XML-import/">XML import</a><a class="post-tag" href="/tags/Python/">Python</a><a class="post-tag" href="/tags/MySQL/">MySQL</a><a class="post-tag" href="/tags/SQL/">SQL</a></div><div class="post-date">Jan 8, 2017</div><div class="post-content"><p>I will not talk about whether it’s a good idea or not to store dump in XML, let’s suppose you have this huge XML file and you need to load it in your database. Let’s find the most efficient way to do it.<br><a id="more"></a><br>In fact the bigger the file is the more problem you have because you need to think about import performance and memory consumption. Also, the schema of the data inside your dump may be messy or totally irrational. All this determines the required flexibility of your import method.</p>
<p>For the sake of this article, I will use <a href="https://archive.org/download/stackexchange" target="_blank" rel="noopener">stackoverflow comments dump</a> which is nearly 10Gb after unpacking.<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="keyword">IF</span> <span class="keyword">NOT</span> <span class="keyword">EXISTS</span> comments (</span><br><span class="line">  <span class="string">"Id"</span> <span class="built_in">serial</span> PRIMARY <span class="keyword">KEY</span>,</span><br><span class="line">  <span class="string">"PostId"</span> <span class="built_in">VARCHAR</span>(<span class="number">255</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">  <span class="string">"Score"</span> <span class="built_in">VARCHAR</span>(<span class="number">255</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">  <span class="string">"Text"</span> <span class="built_in">TEXT</span> <span class="literal">NULL</span>,</span><br><span class="line">  <span class="string">"CreationDate"</span> <span class="built_in">DATE</span> <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">  <span class="string">"UserId"</span> <span class="built_in">VARCHAR</span>(<span class="number">255</span>) <span class="literal">NULL</span></span><br><span class="line">);</span><br></pre></td></tr></table></figure></p>
<p>That’s would a table for our comments dataset. Column names taken from xml node attributes.</p>
<h3 id="Native-import-in-MySQL"><a href="#Native-import-in-MySQL" class="headerlink" title="Native import in MySQL"></a>Native import in MySQL</h3><p>To demonstrate how easy this stuff can be, let’s look at how MySQL handles that kind of task:<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">LOAD</span> <span class="keyword">XML</span> <span class="keyword">LOCAL</span> <span class="keyword">INFILE</span> <span class="string">'/var/lib/mysql/dump/Comments.xml'</span> <span class="keyword">INTO</span> <span class="keyword">TABLE</span> comments <span class="keyword">ROWS</span> <span class="keyword">IDENTIFIED</span> <span class="keyword">BY</span> <span class="string">'&lt;row&gt;'</span>;</span><br></pre></td></tr></table></figure></p>
<p>The Mysql solution is short and simple, but it works only on version &gt;=5.5.  Column names associated with either node attributes or <code>field</code> nodes with required <code>name</code> attribute. In the last case value for the particular column will be taken from node text. If you are interested you can find more about it in <a href="https://dev.mysql.com/doc/refman/5.5/en/load-xml.html" target="_blank" rel="noopener">official Mysql docs</a>.</p>
<p>Import took just about 2 hours for our test XML dump.</p>
<p>Simplicity in MySQL came with a price, as it’s kind of limited in allowed XML formatting. That’s can be a huge problem for example if you import relational data.</p>
<h3 id="XML-processing-functions-in-PostgreSQL"><a href="#XML-processing-functions-in-PostgreSQL" class="headerlink" title="XML processing functions in PostgreSQL"></a>XML processing functions in PostgreSQL</h3><p>I decided to put MySQL example here for a reason. Not that MySQL lacks XML processing, it’s PostgreSQL that don’t have such a simple solution. Postgres have advanced functionality and that usually leads to overcomplicated solutions. When I was searching for a way to do XML import I stumbled upon <a href="http://stackoverflow.com/a/7628453" target="_blank" rel="noopener">this stackoverflow answer</a> which give me a hint on how to solve my problem but introduced a lot of custom user functions, which wasn’t necessary. I ended up with this:<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> comments</span><br><span class="line">  <span class="keyword">SELECT</span> (xpath(<span class="string">'//row/@Id'</span>, x))[<span class="number">1</span>]::<span class="built_in">text</span>::<span class="built_in">int</span> <span class="keyword">AS</span> <span class="keyword">Id</span>,</span><br><span class="line">         (xpath(<span class="string">'//row/@PostId'</span>, x))[<span class="number">1</span>]::<span class="built_in">text</span>::<span class="built_in">int</span> <span class="keyword">AS</span> PostId,</span><br><span class="line">         (xpath(<span class="string">'//row/@Score'</span>, x))[<span class="number">1</span>]::<span class="built_in">text</span>::<span class="built_in">int</span> <span class="keyword">AS</span> Score,</span><br><span class="line">         (xpath(<span class="string">'//row/@Text'</span>, x))[<span class="number">1</span>]::<span class="built_in">text</span> <span class="keyword">AS</span> <span class="built_in">Text</span>,</span><br><span class="line">         (xpath(<span class="string">'//row/@CreationDate'</span>, x))[<span class="number">1</span>]::<span class="built_in">text</span>::<span class="built_in">date</span> <span class="keyword">AS</span> CreationDate,</span><br><span class="line">         (xpath(<span class="string">'//row/@UserId'</span>, x))[<span class="number">1</span>]::<span class="built_in">text</span>::<span class="built_in">int</span> <span class="keyword">AS</span> UserId</span><br><span class="line">  <span class="keyword">FROM</span> <span class="keyword">unnest</span>(xpath(<span class="string">'//row'</span>, pg_read_file(<span class="string">'dump/Comments.xml'</span>)::<span class="keyword">xml</span>)) x;</span><br></pre></td></tr></table></figure></p>
<p>XPath provide a lot of flexibility, this time we are not limited with specific XML format. This method have some non-obvious quirks though:</p>
<ul>
<li>Your dump should be in the data directory of Postgres. That’s the pg_read_file function requirement. There are some alternatives to it in Postgres, more on that matter in stackoverflow thread mentioned above.</li>
<li>As you can see XML field type can’t be directly converted to integer. You need a intermediate conversion to text.</li>
<li>Your dump shoudn’t have BOM. You should <a href="http://www.linuxask.com/questions/how-to-remove-bom-from-utf-8" target="_blank" rel="noopener">remove it</a> before running import otherwise you’ll receive an error.</li>
</ul>
<p>And the most important one: it fails on large XML files: <code>ERROR:  requested length too large</code>. So we either need to split our file on smaller pieces or use different approach.</p>
<h3 id="Import-using-Python"><a href="#Import-using-Python" class="headerlink" title="Import using Python"></a>Import using Python</h3><p>The key in succeeding controlling the whole process is to write your own external script. Obviously, you can’t beat above solutions in execution time, but you definitely can reduce memory consumption. </p>
<p>I used Python 3, lxml module to process dump and psycopg2 for the database connection. With my naive approach at first I got really slow performance, some major improvements were needed. To save you time I will post my final solution and then point out the most important parts:<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> lxml <span class="keyword">import</span> etree</span><br><span class="line"><span class="keyword">import</span> psycopg2</span><br><span class="line"><span class="keyword">from</span> psycopg2.extras <span class="keyword">import</span> execute_values</span><br><span class="line"><span class="keyword">import</span> datetime</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> psutil</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">sizeof_fmt</span><span class="params">(num, suffix=<span class="string">'B'</span>)</span>:</span></span><br><span class="line">    <span class="keyword">for</span> unit <span class="keyword">in</span> [<span class="string">''</span>,<span class="string">'Ki'</span>,<span class="string">'Mi'</span>,<span class="string">'Gi'</span>,<span class="string">'Ti'</span>,<span class="string">'Pi'</span>,<span class="string">'Ei'</span>,<span class="string">'Zi'</span>]:</span><br><span class="line">        <span class="keyword">if</span> abs(num) &lt; <span class="number">1024.0</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">"%3.1f%s%s"</span> % (num, unit, suffix)</span><br><span class="line">        num /= <span class="number">1024.0</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">"%.1f%s%s"</span> % (num, <span class="string">'Yi'</span>, suffix)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">import_xml</span><span class="params">(filename, connect, insert_command, batch = [], batch_size = <span class="number">1000</span>)</span>:</span></span><br><span class="line">    count = <span class="number">0</span></span><br><span class="line">    cursor = connect.cursor()</span><br><span class="line">    process = psutil.Process(os.getpid())</span><br><span class="line">    <span class="keyword">for</span> event, element <span class="keyword">in</span> etree.iterparse(filename, events=(<span class="string">'end'</span>,), tag=<span class="string">'row'</span>):</span><br><span class="line">        count += <span class="number">1</span></span><br><span class="line">        row = [element.get(n) <span class="keyword">for</span> n <span class="keyword">in</span> (<span class="string">'PostId'</span>, <span class="string">'Score'</span>, <span class="string">'Text'</span>, <span class="string">'CreationDate'</span>, <span class="string">'UserId'</span>)]</span><br><span class="line">        batch.append(row)</span><br><span class="line">        <span class="comment"># Free memory</span></span><br><span class="line">        element.clear()</span><br><span class="line">        <span class="keyword">if</span> element.getprevious() <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="keyword">del</span>(element.getparent()[<span class="number">0</span>])</span><br><span class="line">        <span class="comment"># Save batch to DB</span></span><br><span class="line">        <span class="keyword">if</span> count % batch_size == <span class="number">0</span>:</span><br><span class="line">            execute_values(cursor, insert_command, batch)</span><br><span class="line">            print(<span class="string">"\033[?25lImported rows: &#123;&#125; | Memory usage: &#123;&#125;\r"</span>.format(count, sizeof_fmt(process.memory_info().rss)), sep=<span class="string">''</span>, end=<span class="string">''</span>, flush=<span class="literal">True</span>)</span><br><span class="line">            batch = []</span><br><span class="line">    <span class="comment"># Save the rest</span></span><br><span class="line">    <span class="keyword">if</span> len(batch):</span><br><span class="line">        execute_values(cursor, insert_command, batch)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">import_dump</span><span class="params">(db_name = <span class="string">'fts'</span>, db_host = <span class="string">'postgres-db'</span>, db_user = <span class="string">'postgres'</span>, db_pass = <span class="string">''</span>, db_table = <span class="string">'comments'</span>)</span>:</span></span><br><span class="line">    filename = <span class="string">'/dump/Comments.xml'</span></span><br><span class="line">    start_date = datetime.datetime.now()</span><br><span class="line">    <span class="keyword">print</span> (<span class="string">"Import data from &#123;&#125;"</span>.format(filename))</span><br><span class="line">    connect = psycopg2.connect(database=db_name, user=db_user, host=db_host, password=db_pass)</span><br><span class="line">    connect.autocommit = <span class="literal">True</span></span><br><span class="line">    cursor = connect.cursor()</span><br><span class="line"></span><br><span class="line">    insert_command = <span class="string">'INSERT INTO &#123;&#125; (PostId, Score, Text, CreationDate, UserId) VALUES %s'</span>.format(db_table)</span><br><span class="line">    import_xml(filename, connect, insert_command)</span><br><span class="line">    connect.close()</span><br><span class="line"></span><br><span class="line">    end_date = datetime.datetime.now()</span><br><span class="line">    seconds = (end_date - start_date).total_seconds()</span><br><span class="line">    <span class="keyword">print</span> (<span class="string">"\nExecuted in &#123;&#125;s"</span>.format(seconds))</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    import_dump()</span><br></pre></td></tr></table></figure></p>
<ul>
<li><code>etree.iterparse</code> returns iterator providing (event, element) pairs. In contrast with <code>etree.parse</code> iterator provide a way to save memory, you just need to remove previously parsed nodes which you don’t need anymore.</li>
<li>Batch insert is much faster than separate insert for each record. You can tweak <code>batch_size</code> property in order to locate a sweet spot in performance.</li>
<li>psutil module is not required, it’s just to visualize script memory consumption.</li>
</ul>
<p>All in all, it took 2 hours 18 minutes to import 10Gb of stackoverflow comments and used 25Mb of RAM only. Great results!</p>
</div><p class="ending"><i>That's all for today. Happy coding!</i></p></article></div></div></main><div class="fixed-width"><footer><div class="paginator"><a class="prev" href="/2017/05/04/tldr-series-rabbitmq/">PREV</a></div><div id="disqus_thread"></div><script>var disqus_shortname = 'mikemadison';
var disqus_identifier = '2017/01/08/import-xml-into-sql/';
var disqus_title = 'Import XML file into database';
var disqus_url = 'https://mikemadisonweb.github.io/2017/01/08/import-xml-into-sql/';
(function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><script id="dsq-count-scr" src="//mikemadison.disqus.com/count.js" async></script><div class="copyright"><p><a href="/atom.xml"><img class="rss-icon" src="/images/rss_ico.png"><span> Feed |</span></a><a href="/sitemap.xml"><span> Sitemap |</span></a><span> © 2016 - 2020 <a href="https://mikemadisonweb.github.io">Mikhail Bakulin</a>, powered by <a target="_blank">Hexo</a>.</span></p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script><script src="//unpkg.com/mermaid@8.4.4/dist/mermaid.min.js?v=undefined" id="maid-script" mermaidoptioins="{&quot;startOnLoad&quot;:true,&quot;theme&quot;:&quot;forest&quot;,&quot;fontFamily&quot;:&quot;sourcesanspro, Helvetica Neue, Arial, sans-serif&quot;,&quot;logLevel&quot;:3,&quot;sequence&quot;:{&quot;showSequenceNumbers&quot;:true,&quot;useMaxWidth&quot;:true,&quot;actorFontFamily&quot;:&quot;sourcesanspro, Helvetica Neue, Arial, sans-serif&quot;}}"></script><script>if (window.mermaid) {
    var options = JSON.parse(document.getElementById('maid-script').getAttribute('mermaidoptioins'));
    mermaid.initialize(options);
}</script></body></html>